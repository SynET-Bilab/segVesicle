
# Software Documentation

## 1. Draw Presynaptic Area

First, draw the presynaptic area.mod for bin4 data in each folder.

## 2. Cluster Login and Preparation

Log in to the cluster, navigate to the stack out folder using `cd`, and then run the following commands:

```bash
ls */*-bin4-wbp.rec > segVesicle.batch
cp /share/data/CryoET_Data/lvzy/script/segvesv0.1/segVesicle.sbatch ./
```

## 3. Modify sbatch Parameters

Modify the parameters in `segVesicle.sbatch`, usually adjusting only the `pixelsize` (in angstroms) and `snrfalloff`. Additionally, ensure that the correct suffix for the wbp file is set and check whether the area.mod file exists.

## 4. Submit sbatch File

Submit the job by running the sbatch command:

```bash
sbatch segVesicle.sbatch
```

## 5. File Structure After Completion

After completion, the following files will be generated in each tomo folder:

```
p218/
├── area.mod                     # Presynaptic area
├── p218-bin4-wbp.mrc            # Original wbp data
└── ves_seg/                     # Vesicle segmentation working directory
    ├── tomoset/
        └── p218_wbp_resample.mrc         # Resampled wbp data to 17.14Å
    ├── tomo_deconv/
        └── p218_wbp_resample.mrc         # Deconvolution data after resampling
    ├── tomograms.star
    ├── p218_wbp_corrected.mrc   # Isonet-corrected data
    ├── p218_segment.mrc         # Segmentation network output
    ├── p218_label_vesicle.mrc   # Vesicle label map based on density ellipsoid fitting
    └── p218_vesicle.json        # Initial vesicle position and radius information
```

## 6. Napari Environment Setup

Install and activate the napari environment either locally or on the cluster, then run the following commands:

```bash
conda env create -f /share/data/CryoET_Data/lvzy/script/segvesv0.1/environment.yml -n YOUR_ENV_NAME
conda activate YOUR_ENV_NAME
export PATH=PATH_TO_SEGVESICLE_FOLDER/bin:$PATH
export PYTHONPATH=PATH_TO_PARENT_FOLDER_OF_SEGVESICLE_FOLDER:$PYTHONPATH
```

## 7. Launch segVesicle

Navigate to the parent folder of each TOMO_NAME and launch segVesicle:

```bash
segvesicle.py
```

Double-click the directory on the right to enter the operation interface.

## 8. Adding and Deleting Vesicles

- **Delete incorrect vesicles:** Left-click a point inside the incorrect vesicle and press the shortcut key `D`.
- **Add missing vesicles using 3D density fitting:** On the largest cross-section of the missing vesicle, left-click both the center and the vesicle membrane, then press `G`.
- **Add missing vesicles using 2D density fitting:** On the largest cross-section of the missing vesicle, left-click both the center and the vesicle membrane, then press `F`.
- **Add missing vesicles using 2D manual fitting:** On the largest cross-section of the missing vesicle, left-click six points on the vesicle membrane, then press `H`.

All these operations need to be performed in the "edit vesicles" layer.

## 9. Other Features

- Move the mouse to the desired location (without clicking), then press `C` to view the XZ and YZ planes at that position.
- In the lower left corner of the interface, you can choose whether to display the center point of the current view in the three orthogonal planes by selecting "Add cross layer."